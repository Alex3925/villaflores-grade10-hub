<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade 10 Hub - Villaflores College</title>
    
    <link rel="icon" type="image/x-icon" href="https://villaflorescollege.s3.us-west-2.amazonaws.com/favicons/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="https://villaflorescollege.s3.us-west-2.amazonaws.com/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://villaflorescollege.s3.us-west-2.amazonaws.com/favicons/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://villaflorescollege.s3.us-west-2.amazonaws.com/favicons/apple-touch-icon.png">
    <link rel="manifest" href="https://villaflorescollege.s3.us-west-2.amazonaws.com/favicons/site.webmanifest">
    
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;500&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #00E1FF; /* Vibrant cyan */
            --secondary: #FF007A; /* Neon pink */
            --accent: #FFD700; /* Gold */
            --dark: #0D1B2A; /* Deep navy */
            --light: #E5E5E5; /* Soft gray */
            --glow: rgba(0, 225, 255, 0.6);
            --glass-bg: rgba(255, 255, 255, 0.1);
        }
        [data-theme="dark"] {
            --light: #0D1B2A;
            --dark: #E5E5E5;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        body {
            min-height: 100vh; display: flex; background: linear-gradient(135deg, var(--dark), #1A2A44);
            color: var(--light); overflow-x: hidden; transition: background 0.5s;
        }
        .backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, var(--glow), transparent 70%);
            opacity: 0.3; z-index: -1; animation: pulse 5s infinite;
        }
        .container {
            display: grid; grid-template-columns: 300px 1fr 400px; height: 100vh; overflow: hidden;
            max-width: 1600px; margin: 0 auto; padding: 1rem; gap: 1rem;
        }
        .sidebar {
            background: var(--glass-bg); backdrop-filter: blur(10px); border-radius: 15px;
            padding: 1.5rem; overflow-y: auto; border: 1px solid var(--glow);
            animation: slideInLeft 0.5s ease-out;
        }
        .sidebar h2 {
            font-family: 'Orbitron', sans-serif; font-size: 1.5rem; color: var(--accent);
            margin-bottom: 1.5rem; text-shadow: 0 0 10px var(--glow);
        }
        .category { margin-bottom: 2rem; }
        .category h3 {
            font-size: 1.1rem; color: var(--secondary); margin-bottom: 0.8rem;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .user-list { list-style: none; }
        .user-list li {
            display: flex; align-items: center; padding: 0.7rem; border-radius: 10px;
            transition: all 0.3s; cursor: pointer; position: relative;
        }
        .user-list li:hover {
            background: var(--glow); color: var(--dark); transform: translateX(5px);
        }
        .user-status {
            width: 12px; height: 12px; border-radius: 50%; margin-right: 0.8rem;
            background: #00FF00; box-shadow: 0 0 5px #00FF00;
        }
        .user-status.offline { background: #666; box-shadow: none; }
        .chat-area, .call-panel {
            background: var(--glass-bg); backdrop-filter: blur(10px); border-radius: 15px;
            padding: 1.5rem; overflow-y: auto; border: 1px solid var(--glow);
            animation: fadeIn 0.5s ease-out;
        }
        .tabs {
            display: flex; gap: 1rem; margin-bottom: 1rem; padding: 0.5rem;
            background: var(--glass-bg); border-radius: 10px;
        }
        .tab-button {
            padding: 0.7rem 1.5rem; background: transparent; border: none;
            color: var(--light); font-weight: 500; cursor: pointer; transition: all 0.3s;
        }
        .tab-button.active { color: var(--primary); text-shadow: 0 0 15px var(--glow); }
        .tab-button:hover { color: var(--accent); transform: scale(1.05); }
        .chat-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;
            border-bottom: 1px solid var(--glow); padding-bottom: 0.5rem;
        }
        .chat-header span {
            font-size: 1.2rem; font-weight: 500; color: var(--accent);
        }
        .chat-header a { color: var(--secondary); text-decoration: none; font-size: 0.9rem; }
        .chat-messages { flex: 1; padding: 1rem 0; overflow-y: auto; }
        .message {
            margin: 0.5rem 0; padding: 1rem; border-radius: 15px; max-width: 65%;
            position: relative; animation: slideInRight 0.3s ease-out;
        }
        .message.sent { background: var(--primary); margin-left: auto; }
        .message.received { background: var(--secondary); }
        .message-header { font-size: 0.9rem; color: var(--light); margin-bottom: 0.3rem; }
        .message-timestamp { font-size: 0.7rem; color: #BBB; text-align: right; }
        .chat-input {
            display: flex; gap: 0.5rem; padding: 0.5rem 0; border-top: 1px solid var(--glow);
        }
        .chat-input input[type="text"] {
            flex: 1; padding: 0.8rem; border: none; border-radius: 20px;
            background: rgba(255, 255, 255, 0.2); color: var(--light); font-size: 1rem;
        }
        .chat-input button {
            background: var(--primary); border: none; border-radius: 50%; width: 40px; height: 40px;
            color: var(--dark); font-size: 1rem; cursor: pointer; transition: all 0.3s;
        }
        .chat-input button:hover { background: var(--accent); transform: scale(1.1); }
        .call-panel { text-align: center; }
        .call-panel h2 { font-size: 1.4rem; color: var(--accent); margin-bottom: 1rem; }
        .call-panel video {
            width: 100%; max-width: 350px; border-radius: 10px; margin: 0.5rem 0;
            background: #000; box-shadow: 0 0 10px var(--glow);
        }
        .call-panel button {
            padding: 1rem 2rem; background: var(--secondary); color: var(--light);
            border: none; border-radius: 25px; margin: 0.5rem; font-size: 1rem;
            transition: all 0.3s;
        }
        .call-panel button:hover { background: var(--primary); transform: translateY(-2px); }
        .call-panel button:disabled { background: #666; cursor: not-allowed; }
        .theme-toggle {
            position: fixed; top: 1rem; right: 1rem; background: var(--primary);
            color: var(--light); border: none; border-radius: 50%; width: 45px;
            height: 45px; font-size: 1.3rem; cursor: pointer; transition: all 0.3s;
        }
        .theme-toggle:hover { transform: scale(1.2); background: var(--accent); }
        .notification {
            position: fixed; top: 4rem; right: 1rem; background: var(--secondary);
            color: var(--light); padding: 0.8rem 1.2rem; border-radius: 10px;
            box-shadow: 0 0 10px var(--glow); display: none; animation: popIn 0.5s;
        }
        .settings {
            position: fixed; top: 6rem; right: 1rem; background: var(--glass-bg);
            backdrop-filter: blur(10px); padding: 1rem; border-radius: 10px;
            border: 1px solid var(--glow); display: none; width: 250px;
        }
        .settings label { display: block; margin: 0.5rem 0; color: var(--light); }
        .settings input { margin-left: 0.5rem; }
        @keyframes pulse { 0%, 100% { opacity: 0.3; } 50% { opacity: 0.5; } }
        @keyframes slideInLeft { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideInRight { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @media (max-width: 1200px) {
            .container { grid-template-columns: 250px 1fr; }
            .call-panel { display: none; }
        }
        @media (max-width: 800px) {
            .container { grid-template-columns: 1fr; }
            .sidebar { position: fixed; top: 0; left: -250px; height: 100%; transition: left 0.3s; }
            .sidebar.active { left: 0; }
            .chat-area { margin-left: 0; }
            .theme-toggle { top: 0.5rem; right: 0.5rem; }
        }
    </style>
</head>
<body data-theme="light">
    <div class="backdrop"></div>
    <button class="theme-toggle" aria-label="Toggle theme" onclick="toggleTheme()">üåô</button>
    <button class="sidebar-toggle" aria-label="Toggle sidebar" onclick="toggleSidebar()">‚ò∞</button>
    <div class="notification" id="notification"></div>
    <div class="settings" id="settings">
        <label><input type="checkbox" id="notifications" checked> Enable Notifications</label>
        <label><input type="color" id="themeColor" value="#00E1FF"> Accent Color</label>
    </div>
    
    <div class="container">
        <div class="sidebar" id="sidebar">
            <h2>Chat Hub</h2>
            <div class="category">
                <h3>School Works</h3>
                <ul class="user-list" id="schoolWorksUsers"></ul>
            </div>
            <div class="category">
                <h3>General</h3>
                <ul class="user-list" id="generalUsers"></ul>
            </div>
            <button onclick="toggleSettings()" aria-label="Open settings">‚öôÔ∏è Settings</button>
        </div>
        <div class="chat-area">
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('chat')">Chat</button>
                <button class="tab-button" onclick="switchTab('call')">Call Room</button>
            </div>
            <div class="chat-content active" id="chatContent">
                <div class="chat-header">
                    <span>Welcome, <span id="username"></span></span>
                    <a href="/index.html" aria-label="Logout">Logout</a>
                </div>
                <div class="chat-messages" id="chatMessages" aria-live="polite"></div>
                <form class="chat-input" id="chatForm">
                    <input type="text" id="messageInput" placeholder="Type a message..." required aria-label="Message input">
                    <button type="submit" aria-label="Send message"><i class="fas fa-paper-plane"></i></button>
                </form>
            </div>
            <div class="call-content" id="callContent" style="display: none;">
                <div class="chat-header">
                    <span>Call Room</span>
                    <button onclick="endCall()" aria-label="End call">‚úñÔ∏è</button>
                </div>
                <video id="localVideo" autoplay muted playsinline></video>
                <video id="remoteVideo" autoplay playsinline></video>
                <div class="call-controls">
                    <button id="toggleMic" aria-label="Toggle microphone"><i class="fas fa-microphone"></i></button>
                    <button id="toggleVideo" aria-label="Toggle video"><i class="fas fa-video"></i></button>
                </div>
            </div>
        </div>
        <div class="call-panel">
            <h2>Call Panel</h2>
            <button id="startVoiceCall" aria-label="Start voice call">Voice Call</button>
            <button id="startVideoCall" aria-label="Start video call">Video Call</button>
        </div>
    </div>

    <script>
        const socket = io(window.location.origin.replace(/^http/, 'ws'), {
            auth: { token: localStorage.getItem('token') },
            transports: ['websocket', 'polling'],
            reconnectionAttempts: 5
        });

        const username = localStorage.getItem('username') || 'User';
        document.getElementById('username').textContent = username;

        if (!localStorage.getItem('token')) {
            window.location.href = '/index.html';
        }

        const chatMessages = document.getElementById('chatMessages');
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');
        const schoolWorksUsers = document.getElementById('schoolWorksUsers');
        const generalUsers = document.getElementById('generalUsers');
        const startVoiceCallBtn = document.getElementById('startVoiceCall');
        const startVideoCallBtn = document.getElementById('startVideoCall');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const toggleMicBtn = document.getElementById('toggleMic');
        const toggleVideoBtn = document.getElementById('toggleVideo');
        const notification = document.getElementById('notification');
        const settings = document.getElementById('settings');
        const themeColor = document.getElementById('themeColor');

        let targetUser = null;
        let peerConnection = null;
        let localStream = null;
        let isMicOn = true;
        let isVideoOn = true;

        const users = [
            'admin', 'website owner', 'user1', 'user2', 'user3', 'user4', 'user5', 'user6', 'user7', 'user8',
            'user9', 'user10', 'user11', 'user12', 'user13', 'user14', 'user15', 'user16', 'user17', 'user18',
            'user19', 'user20', 'user21', 'user22', 'user23', 'user24', 'user25', 'user26', 'user27', 'user28',
            'user29', 'user30', 'user31', 'user32', 'user33', 'user34', 'user35', 'user36', 'user37', 'user38',
            'user39', 'user40', 'user41', 'user42', 'user43', 'user44', 'user45', 'user46', 'user47', 'user48',
            'user49', 'user50', 'user51', 'user52', 'user53', 'user54', 'user55', 'user56', 'user57', 'user58'
        ];

        function toggleTheme() {
            const body = document.body;
            const theme = body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
            body.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            document.querySelector('.theme-toggle').textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            updateThemeColor();
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.chat-content, .call-content').forEach(content => content.style.display = 'none');
            document.querySelector(`.tab-button[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(tab === 'chat' ? 'chatContent' : 'callContent').style.display = 'block';
        }

        function updateUserList(category, userListElement) {
            userListElement.innerHTML = '';
            users.forEach(user => {
                const li = document.createElement('li');
                li.innerHTML = `<span class="user-status ${user === username ? '' : 'offline'}"></span>${user}`;
                li.onclick = () => {
                    targetUser = user;
                    startVoiceCallBtn.disabled = user === username;
                    startVideoCallBtn.disabled = user === username;
                    showNotification(`Selected ${user} for call`);
                };
                userListElement.appendChild(li);
            });
        }

        function showNotification(message) {
            if (document.getElementById('notifications').checked) {
                notification.textContent = message;
                notification.style.display = 'block';
                setTimeout(() => notification.style.display = 'none', 3000);
            }
        }

        function toggleSettings() {
            settings.style.display = settings.style.display === 'block' ? 'none' : 'block';
        }

        function updateThemeColor() {
            const color = themeColor.value;
            document.documentElement.style.setProperty('--primary', color);
            localStorage.setProperty('--primary', color);
        }

        themeColor.addEventListener('change', updateThemeColor);

        socket.on('connect', () => {
            console.log('Connected');
            socket.emit('register', { username });
            updateUserList('schoolWorks', schoolWorksUsers);
            updateUserList('general', generalUsers);
        });

        socket.on('userPresence', (users) => {
            updateUserList('schoolWorks', schoolWorksUsers);
            updateUserList('general', generalUsers);
        });

        socket.on('newMessage', (message) => {
            const div = document.createElement('div');
            div.className = `message ${message.username === username ? 'sent' : 'received'}`;
            div.innerHTML = `<div class="message-header">${message.username}</div><div>${message.text}</div><div class="message-timestamp">${new Date(message.timestamp).toLocaleTimeString()}</div>`;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            showNotification(`New message from ${message.username}`);
        });

        chatForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const text = messageInput.value.trim();
            if (text) {
                socket.emit('sendMessage', { text, category: 'schoolWorks' });
                messageInput.value = '';
            }
        });

        document.querySelector('.chat-header a').addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            if (peerConnection) peerConnection.close();
            socket.disconnect();
            window.location.href = '/index.html';
        });

        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' }
            ]
        };

        async function startCall(isVideo) {
            if (!targetUser) return alert('Select a user first!');
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: isVideo });
                localVideo.srcObject = localStream;
                document.getElementById('callContent').style.display = 'block';
                switchTab('call');

                peerConnection = new RTCPeerConnection(configuration);
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                peerConnection.ontrack = (event) => {
                    remoteVideo.srcObject = event.streams[0];
                    showNotification('Call connected with ' + targetUser);
                };

                peerConnection.onicecandidate = (event) => event.candidate && socket.emit('ice-candidate', { target: targetUser, candidate: event.candidate });
                peerConnection.oniceconnectionstatechange = () => {
                    if (peerConnection.iceConnectionState === 'disconnected') endCall();
                };

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                socket.emit('offer', { offer, target: targetUser, sender: username });
            } catch (e) {
                alert('Call failed: ' + e.message);
                endCall();
            }
        }

        function endCall() {
            if (peerConnection) peerConnection.close();
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            peerConnection = null;
            localStream = null;
            localVideo.srcObject = null;
            remoteVideo.srcObject = null;
            document.getElementById('callContent').style.display = 'none';
            switchTab('chat');
            socket.emit('end-call', { target: targetUser });
            showNotification('Call ended');
        }

        startVoiceCallBtn.addEventListener('click', () => startCall(false));
        startVideoCallBtn.addEventListener('click', () => startCall(true));

        toggleMicBtn.addEventListener('click', () => {
            if (localStream) {
                isMicOn = !isMicOn;
                localStream.getAudioTracks().forEach(track => track.enabled = isMicOn);
                toggleMicBtn.innerHTML = `<i class="fas fa-microphone${isMicOn ? '' : '-slash'}"></i>`;
            }
        });

        toggleVideoBtn.addEventListener('click', () => {
            if (localStream) {
                isVideoOn = !isVideoOn;
                localStream.getVideoTracks().forEach(track => track.enabled = isVideoOn);
                toggleVideoBtn.innerHTML = `<i class="fas fa-video${isVideoOn ? '' : '-slash'}"></i>`;
            }
        });

        socket.on('offer', async (data) => {
            if (data.target === username) {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: data.offer.type === 'video' });
                localVideo.srcObject = localStream;
                document.getElementById('callContent').style.display = 'block';
                switchTab('call');

                peerConnection = new RTCPeerConnection(configuration);
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                peerConnection.ontrack = (event) => remoteVideo.srcObject = event.streams[0];
                peerConnection.onicecandidate = (event) => event.candidate && socket.emit('ice-candidate', { target: data.sender, candidate: event.candidate });

                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                socket.emit('answer', { answer, target: data.sender });
            }
        });

        socket.on('answer', (data) => data.target === username && peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer)));
        socket.on('ice-candidate', (data) => data.target === username && peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate)));
        socket.on('end-call', (data) => data.target === username && endCall());
    </script>
</body>
</html>
