<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade 10 Hub - Villaflores College</title>
    
    <link rel="icon" type="image/x-icon" href="https://villaflorescollege.s3.us-west-2.amazonaws.com/favicons/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="https://villaflorescollege.s3.us-west-2.amazonaws.com/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://villaflorescollege.s3.us-west-2.amazonaws.com/favicons/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://villaflorescollege.s3.us-west-2.amazonaws.com/favicons/apple-touch-icon.png">
    <link rel="manifest" href="https://villaflorescollege.s3.us-west-2.amazonaws.com/favicons/site.webmanifest">
    
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #00ffcc;
            --secondary: #ff00ff;
            --accent: #ffaa00;
            --dark: #0a0f1a;
            --light: #f0f4f8;
            --neon: rgba(0, 255, 204, 0.8);
        }
        [data-theme="dark"] {
            --light: #0a0f1a;
            --dark: #f0f4f8;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body {
            min-height: 100vh; display: flex; background: var(--dark);
            color: var(--light); overflow-x: hidden;
        }
        .backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, var(--primary), var(--dark));
            opacity: 0.1; z-index: -1;
        }
        .container {
            display: flex; flex: 1; max-width: 1400px; margin: 0 auto; padding: 1rem;
        }
        .sidebar {
            width: 300px; background: rgba(10, 15, 26, 0.9);
            backdrop-filter: blur(10px); padding: 1rem; overflow-y: auto;
            border-right: 1px solid var(--neon); transition: transform 0.3s;
        }
        .sidebar.collapsed { transform: translateX(-100%); width: 0; padding: 0; }
        .sidebar-toggle {
            display: none; position: fixed; top: 1rem; left: 1rem;
            background: var(--primary); color: var(--light); border: none;
            border-radius: 50%; width: 40px; height: 40px; font-size: 1.2rem;
            cursor: pointer; z-index: 100;
        }
        .sidebar h2 {
            font-family: 'Orbitron', sans-serif; font-size: 1.3rem; color: var(--neon);
            margin-bottom: 1rem; text-shadow: 0 0 5px var(--neon);
        }
        .category {
            margin-bottom: 1.5rem; border-bottom: 1px solid var(--neon);
        }
        .category h3 {
            font-size: 1rem; color: var(--accent); margin-bottom: 0.5rem;
        }
        .user-list { list-style: none; }
        .user-list li {
            display: flex; align-items: center; padding: 0.5rem;
            border-radius: 8px; cursor: pointer; transition: all 0.3s;
        }
        .user-list li:hover {
            background: var(--neon); color: var(--dark); transform: scale(1.02);
        }
        .user-status {
            width: 10px; height: 10px; border-radius: 50%; margin-right: 0.5rem;
            background: #44b700;
        }
        .user-status.offline { background: #B0B3B8; }
        .chat-area {
            flex: 1; display: flex; flex-direction: column; padding: 1rem;
        }
        .tabs {
            display: flex; gap: 1rem; margin-bottom: 1rem; padding: 0.5rem;
            background: rgba(10, 15, 26, 0.9); backdrop-filter: blur(10px);
            border-radius: 10px;
        }
        .tab-button {
            padding: 0.5rem 1rem; background: transparent; border: none;
            color: var(--light); font-weight: 600; cursor: pointer;
            transition: color 0.3s, text-shadow 0.3s;
        }
        .tab-button.active { color: var(--primary); text-shadow: 0 0 10px var(--neon); }
        .tab-button:hover { color: var(--accent); }
        .chat-content, .call-room {
            flex: 1; display: none; padding: 1rem; background: rgba(10, 15, 26, 0.5);
            backdrop-filter: blur(10px); border-radius: 10px;
        }
        .chat-content.active, .call-room.active { display: block; }
        .chat-header { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; }
        .chat-header span {
            font-weight: 600; font-size: 1.1rem; color: var(--neon);
        }
        .chat-header a { color: var(--accent); text-decoration: none; }
        .chat-messages { flex: 1; padding: 1rem; overflow-y: auto; }
        .message {
            margin-bottom: 0.5rem; padding: 0.8rem; border-radius: 15px;
            max-width: 70%; position: relative; animation: slideIn 0.3s;
        }
        .message.sent { background: var(--primary); margin-left: auto; }
        .message.received { background: rgba(255, 255, 255, 0.1); }
        .chat-input { display: flex; padding: 0.5rem; gap: 0.5rem; }
        .chat-input input[type="text"] {
            flex: 1; padding: 0.8rem; border: none; border-radius: 20px;
            background: rgba(255, 255, 255, 0.1); color: var(--light);
        }
        .chat-input button { background: var(--primary); border: none; border-radius: 50%; width: 40px; height: 40px; }
        .call-room { text-align: center; }
        .call-room button {
            padding: 1rem; background: var(--secondary); color: var(--light);
            border: none; border-radius: 25px; margin: 0.5rem; font-size: 1rem;
        }
        .theme-toggle {
            position: fixed; top: 1rem; right: 1rem; background: var(--primary);
            color: var(--light); border: none; border-radius: 50%; width: 40px;
            height: 40px; font-size: 1.2rem; cursor: pointer;
        }
        @keyframes slideIn { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @media (max-width: 768px) {
            .container { flex-direction: column; }
            .sidebar { position: fixed; top: 0; left: 0; height: 100%; transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
            .sidebar-toggle { display: block; }
        }
    </style>
</head>
<body data-theme="light">
    <button class="theme-toggle" aria-label="Toggle theme" onclick="toggleTheme()">🌙</button>
    <button class="sidebar-toggle" aria-label="Toggle sidebar" onclick="toggleSidebar()">☰</button>
    <div class="backdrop"></div>
    
    <div class="container">
        <div class="sidebar" id="sidebar">
            <h2>Chat Categories</h2>
            <div class="category">
                <h3>School Works</h3>
                <ul class="user-list" id="schoolWorksUsers"></ul>
            </div>
            <!-- Add more categories as needed -->
            <div class="category">
                <h3>General</h3>
                <ul class="user-list" id="generalUsers"></ul>
            </div>
        </div>
        <div class="chat-area">
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('chat')">Chat</button>
                <button class="tab-button" onclick="switchTab('call')">Call Room</button>
            </div>
            <div class="chat-content active" id="chatContent">
                <div class="chat-header">
                    <span>Welcome, <span id="username"></span></span>
                    <a href="/index.html" aria-label="Logout">Logout</a>
                </div>
                <div class="chat-messages" id="chatMessages" aria-live="polite"></div>
                <form class="chat-input" id="chatForm">
                    <input type="text" id="messageInput" placeholder="Type a message..." required aria-label="Message input">
                    <button type="submit" aria-label="Send message"><i class="fas fa-paper-plane"></i></button>
                </form>
            </div>
            <div class="call-room" id="callRoom">
                <h2>Call Room</h2>
                <button id="startVoiceCall" aria-label="Start voice call">Start Voice Call</button>
                <button id="startVideoCall" aria-label="Start video call">Start Video Call</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io(window.location.origin.replace(/^http/, 'ws'), {
            auth: { token: localStorage.getItem('token') },
            transports: ['websocket', 'polling'],
            reconnectionAttempts: 5
        });

        const username = localStorage.getItem('username') || 'User';
        document.getElementById('username').textContent = username;

        if (!localStorage.getItem('token')) {
            window.location.href = '/index.html';
        }

        const chatMessages = document.getElementById('chatMessages');
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');
        const schoolWorksUsers = document.getElementById('schoolWorksUsers');
        const generalUsers = document.getElementById('generalUsers');
        const startVoiceCallBtn = document.getElementById('startVoiceCall');
        const startVideoCallBtn = document.getElementById('startVideoCall');

        let targetUser = null;
        let peerConnection = null;
        let localStream = null;

        const users = [
            'admin', 'website owner', 'user1', 'user2', 'user3', 'user4', 'user5', 'user6', 'user7', 'user8',
            'user9', 'user10', 'user11', 'user12', 'user13', 'user14', 'user15', 'user16', 'user17', 'user18',
            'user19', 'user20', 'user21', 'user22', 'user23', 'user24', 'user25', 'user26', 'user27', 'user28',
            'user29', 'user30', 'user31', 'user32', 'user33', 'user34', 'user35', 'user36', 'user37', 'user38',
            'user39', 'user40', 'user41', 'user42', 'user43', 'user44', 'user45', 'user46', 'user47', 'user48',
            'user49', 'user50', 'user51', 'user52', 'user53', 'user54', 'user55', 'user56', 'user57', 'user58'
        ];

        function toggleTheme() {
            const body = document.body;
            const theme = body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
            body.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            document.querySelector('.theme-toggle').textContent = theme === 'light' ? '🌙' : '☀️';
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        if (localStorage.getItem('theme') === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            document.querySelector('.theme-toggle').textContent = '☀️';
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.chat-content, .call-room').forEach(content => content.classList.remove('active'));
            document.querySelector(`.tab-button[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(tab === 'chat' ? 'chatContent' : 'callRoom').classList.add('active');
        }

        function updateUserList(category, userListElement) {
            userListElement.innerHTML = '';
            users.forEach(user => {
                const li = document.createElement('li');
                li.innerHTML = `<span class="user-status ${user === username ? '' : 'offline'}"></span>${user}`;
                li.onclick = () => { targetUser = user; startVoiceCallBtn.disabled = user === username; startVideoCallBtn.disabled = user === username; };
                userListElement.appendChild(li);
            });
        }

        socket.on('connect', () => {
            console.log('Connected');
            socket.emit('register', { username });
            updateUserList('schoolWorks', schoolWorksUsers);
            updateUserList('general', generalUsers);
        });

        socket.on('userPresence', (users) => {
            updateUserList('schoolWorks', schoolWorksUsers);
            updateUserList('general', generalUsers);
        });

        socket.on('newMessage', (message) => {
            const div = document.createElement('div');
            div.className = `message ${message.username === username ? 'sent' : 'received'}`;
            div.innerHTML = `<div>${message.text}</div><div class="message-timestamp">${new Date(message.timestamp).toLocaleTimeString()}</div>`;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });

        chatForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const text = messageInput.value.trim();
            if (text) {
                socket.emit('sendMessage', { text, category: 'schoolWorks' }); // Default to School Works
                messageInput.value = '';
            }
        });

        document.querySelector('.chat-header a').addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            socket.disconnect();
            window.location.href = '/index.html';
        });

        const configuration = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        async function startCall(isVideo) {
            if (!targetUser) return alert('Select a user first!');
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: isVideo });
            peerConnection = new RTCPeerConnection(configuration);
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            peerConnection.onicecandidate = (e) => e.candidate && socket.emit('ice-candidate', { target: targetUser, candidate: e.candidate });
            peerConnection.ontrack = (e) => console.log('Call connected');
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            socket.emit('offer', { offer, target: targetUser, sender: username });
        }

        startVoiceCallBtn.addEventListener('click', () => startCall(false));
        startVideoCallBtn.addEventListener('click', () => startCall(true));

        socket.on('offer', async (data) => {
            if (data.target === username) {
                peerConnection = new RTCPeerConnection(configuration);
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: data.offer.type === 'video' });
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                socket.emit('answer', { answer, target: data.sender });
            }
        });

        socket.on('answer', (data) => data.target === username && peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer)));
        socket.on('ice-candidate', (data) => data.target === username && peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate)));
    </script>
</body>
</html>
